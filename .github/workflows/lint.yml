name: Lint Scripts

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run ShellCheck
        run: |
          shellcheck --version
          shell_files="$(git ls-files '*.sh')"
          if [ -z "$shell_files" ]; then
            echo "No shell scripts found"
            exit 0
          fi
          printf '%s\n' "$shell_files" | xargs shellcheck
      - name: Install shfmt
        run: |
          sudo apt-get update
          sudo apt-get install -y shfmt

      - name: Check shell formatting with shfmt
        run: |
          echo "Running shfmt format check..."
          shell_files="$(git ls-files '*.sh')"
          if [ -z "$shell_files" ]; then
            echo "No shell scripts found"
            exit 0
          fi
          printf '%s\n' "$shell_files" | xargs shfmt -l | tee /tmp/shfmt_unformatted || true
          if [ -s /tmp/shfmt_unformatted ]; then
            echo "shfmt detected unformatted files:" >&2
            cat /tmp/shfmt_unformatted >&2
            echo "Run: shfmt -w <files> to format them" >&2
            exit 1
          fi

  python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
      - name: Run ruff
        run: |
          uv tool run ruff check dot_config/taskwarrior/hooks dot_config/opencode
