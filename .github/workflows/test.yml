name: Test

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  test-nushell:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Nushell
        run: brew install nushell
      - name: Prepare Nushell cache
        run: |
          mkdir -p "$HOME/.cache/nushell-init"
          touch "$HOME/.cache/nushell-init/starship.nu"
          touch "$HOME/.cache/nushell-init/zoxide.nu"
          touch "$HOME/.cache/nushell-init/carapace.nu"
          touch "$HOME/.cache/nushell-init/atuin.nu"
      - name: Symlink nushell config to XDG location
        run: |
          cp "$GITHUB_WORKSPACE/dot_config/nushell/local.nu.example" "$GITHUB_WORKSPACE/dot_config/nushell/local.nu"
          mkdir -p "$HOME/.config"
          ln -s "$GITHUB_WORKSPACE/dot_config/nushell" "$HOME/.config/nushell"
      - name: Source autoload modules
        run: |
          nu --env-config dot_config/nushell/env.nu --config dot_config/nushell/config.nu -c 'version'
      - name: Verify XDG dirs
        run: |
          nu --env-config dot_config/nushell/env.nu --config dot_config/nushell/config.nu -c 'xdg-dirs | to json'

  test-opencode:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
      - name: Run OpenCode tests
        run: |
          uv run --with-requirements requirements.txt --with pytest --directory dot_config/opencode pytest

  validate-nix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v31
      - name: Validate Nix evaluation
        run: |
          nix eval --no-write-lock-file .#darwinConfigurations.macbook.config.system.stateVersion
          nix eval --no-write-lock-file .#darwinConfigurations.macbook.config.home-manager.users.drgnxd.home.stateVersion
          nix flake check --no-build --no-write-lock-file

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
      - name: Scan for secrets drift
        run: |
          uv tool run detect-secrets scan --baseline .secrets.baseline
          uv run --directory . python - <<'PY'
          import json
          import subprocess
          import sys
          from pathlib import Path

          def load(path: str):
              return json.loads(Path(path).read_text())

          def load_committed(path: str):
              data = subprocess.check_output(["git", "show", f"HEAD:{path}"], text=True)
              return json.loads(data)

          def normalize(data: dict):
              data.pop("generated_at", None)
              return data

          current = normalize(load(".secrets.baseline"))
          committed = normalize(load_committed(".secrets.baseline"))

          if current != committed:
              print(
                  "detect-secrets baseline drift detected. "
                  "Run: uv tool run detect-secrets scan --baseline .secrets.baseline",
                  file=sys.stderr,
              )
              sys.exit(1)
          PY

  validate-config:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
      - name: Validate YAML and TOML syntax
        run: |
          uv run --with pyyaml --directory . python - <<'PY'
          from pathlib import Path
          import sys
          import tomllib
          import yaml

          def should_skip(path: Path) -> bool:
              parts = path.parts
              return ".venv" in parts or ".git" in parts

          errors = []
          for path in Path(".").rglob("*"):
              if not path.is_file():
                  continue
              if should_skip(path):
                  continue
              if path.suffix in {".yaml", ".yml"}:
                  try:
                      yaml.safe_load(path.read_text(encoding="utf-8"))
                  except Exception as exc:
                      errors.append(f"YAML: {path}: {exc}")
              elif path.suffix == ".toml":
                  try:
                      tomllib.loads(path.read_text(encoding="utf-8"))
                  except Exception as exc:
                      errors.append(f"TOML: {path}: {exc}")

          if errors:
              print("\n".join(errors), file=sys.stderr)
              raise SystemExit(1)
          print("YAML/TOML validation passed")
          PY
      - name: Validate OpenCode skills catalog
        run: |
          uv run --with-requirements requirements.txt --directory dot_config/opencode python skills_loader.py --validate

  test-taskwarrior:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v7
      - name: Run Taskwarrior hook tests
        run: |
          uv run --with pytest --directory dot_config/taskwarrior/hooks pytest
