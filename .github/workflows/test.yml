name: Test

on:
  push:
  pull_request:

jobs:
  test-nushell:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Nushell
        run: brew install nushell
      - name: Source autoload modules
        run: |
          nu -c 'let files = (ls dot_config/nushell/autoload/*.nu | get name | sort); for file in $files { source $file }'
      - name: Verify XDG dirs
        run: |
          nu -c 'source dot_config/nushell/autoload/00-constants.nu; xdg-dirs | to json'

  test-opencode:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - name: Run OpenCode tests
        run: |
          uv run --with-requirements requirements.txt --with pytest --directory dot_config/opencode pytest

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - name: Scan for secrets drift
        run: |
          uv tool run detect-secrets scan --baseline .secrets.baseline --all-files > /tmp/secrets.baseline
          diff -u .secrets.baseline /tmp/secrets.baseline

  validate-config:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - name: Validate YAML and TOML syntax
        run: |
          uv run --with pyyaml --directory . python - <<'PY'
          from pathlib import Path
          import sys
          import tomllib
          import yaml

          def should_skip(path: Path) -> bool:
              parts = path.parts
              return ".venv" in parts or ".git" in parts

          errors = []
          for path in Path(".").rglob("*"):
              if not path.is_file():
                  continue
              if should_skip(path):
                  continue
              if path.suffix in {".yaml", ".yml"}:
                  try:
                      yaml.safe_load(path.read_text(encoding="utf-8"))
                  except Exception as exc:
                      errors.append(f"YAML: {path}: {exc}")
              elif path.suffix == ".toml":
                  try:
                      tomllib.loads(path.read_text(encoding="utf-8"))
                  except Exception as exc:
                      errors.append(f"TOML: {path}: {exc}")

          if errors:
              print("\n".join(errors), file=sys.stderr)
              raise SystemExit(1)
          print("YAML/TOML validation passed")
          PY
      - name: Validate OpenCode skills catalog
        run: |
          uv run --with-requirements requirements.txt --directory dot_config/opencode python skills_loader.py --validate

  test-taskwarrior:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - name: Run Taskwarrior hook tests
        run: |
          uv run --with pytest --directory dot_config/taskwarrior/hooks pytest
