#!/usr/bin/env bash
set -euo pipefail

# Brewfile hash: {{ include "dot_config/homebrew/Brewfile.tmpl" | sha256sum }}

SOURCE_ROOT="${CHEZMOI_SOURCE_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)}"

# Source shared bootstrap
# shellcheck source=../lib/bootstrap.sh
# shellcheck disable=SC1091
source "${SOURCE_ROOT}/.internal_scripts/lib/bootstrap.sh"

BREWFILE_TARGET="${XDG_CONFIG_HOME:-$HOME/.config}/homebrew/Brewfile"
BREWFILE_SOURCE="{{ .chezmoi.sourceDir }}/dot_config/homebrew/Brewfile"
BREWFILE_TEMPLATE="{{ .chezmoi.sourceDir }}/dot_config/homebrew/Brewfile.tmpl"
TMP_BREWFILE=""
BUNDLE_OPTIONS=("--no-upgrade")

# Silence shellcheck warnings for template variables that may be referenced
# by templates or external invocation paths.
: "${BREWFILE_TARGET:-}"
: "${BREWFILE_TEMPLATE:-}"

cleanup() {
  if [ -n "$TMP_BREWFILE" ] && [ -f "$TMP_BREWFILE" ]; then
    rm -f "$TMP_BREWFILE"
  fi
}

trap cleanup EXIT

log_info "Checking for Homebrew..."

if command -v brew >/dev/null 2>&1; then
  log_info "Homebrew found. Preparing Brewfile..."

  brewfile_path=$(resolve_brewfile "$BREWFILE_SOURCE") || exit 1
  TMP_BREWFILE=${RESOLVED_BREWFILE_TMP:-""}

  # Prevent chezmoi persistent state lock contention during brew bundle
  if chezmoi state dump >/dev/null 2>&1; then
    :
  else
    echo "Warning: unable to read chezmoi state; continuing" >&2
  fi

  if brew bundle --file="$brewfile_path" "${BUNDLE_OPTIONS[@]}"; then
    log_success "brew bundle completed successfully"
  else
    log_error "brew bundle failed"
    echo "Hint: run 'brew bundle --file=$brewfile_path --verbose' to inspect errors." >&2
    exit 1
  fi
else
  log_error "Homebrew not found. Skipping brew bundle"
  echo "Please install Homebrew manually or ensure it is in your PATH." >&2
  exit 1
fi
