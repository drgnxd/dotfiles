#!/usr/bin/env bash
set -euo pipefail

# Brewfile hash: {{ include "dot_config/homebrew/Brewfile.tmpl" | sha256sum }}

# Source common library
if [ -n "${CHEZMOI_SOURCE_DIR:-}" ]; then
  LIB_DIR="${CHEZMOI_SOURCE_DIR}/.internal_scripts/lib"
else
  LIB_DIR="$(cd "$(dirname "$0")/../lib" && pwd)"
fi
source "${LIB_DIR}/common.sh"

BREWFILE_TARGET="${XDG_CONFIG_HOME:-$HOME/.config}/homebrew/Brewfile"
BREWFILE_SOURCE="{{ .chezmoi.sourceDir }}/dot_config/homebrew/Brewfile"
BREWFILE_TEMPLATE="{{ .chezmoi.sourceDir }}/dot_config/homebrew/Brewfile.tmpl"
TMP_BREWFILE=""
BUNDLE_OPTIONS=("--no-upgrade")

cleanup() {
  if [ -n "$TMP_BREWFILE" ] && [ -f "$TMP_BREWFILE" ]; then
    rm -f "$TMP_BREWFILE"
  fi
}

trap cleanup EXIT

log_info "Checking for Homebrew..."

if command -v brew >/dev/null 2>&1; then
  log_info "Homebrew found. Preparing Brewfile..."

  brewfile_path=$(resolve_brewfile "$BREWFILE_SOURCE") || exit 1
  TMP_BREWFILE=${RESOLVED_BREWFILE_TMP:-""}

  # Prevent chezmoi persistent state lock contention during brew bundle
  if chezmoi state dump >/dev/null 2>&1; then
    :
  else
    echo "Warning: unable to read chezmoi state; continuing" >&2
  fi

  if brew bundle --file="$brewfile_path" "${BUNDLE_OPTIONS[@]}"; then
    log_success "brew bundle completed successfully"
  else
    log_error "brew bundle failed"
    echo "Hint: run 'brew bundle --file=$brewfile_path --verbose' to inspect errors." >&2
    exit 1
  fi
else
  log_error "Homebrew not found. Skipping brew bundle"
  echo "Please install Homebrew manually or ensure it is in your PATH." >&2
  exit 1
fi
