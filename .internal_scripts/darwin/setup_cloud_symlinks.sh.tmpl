#!/bin/bash
set -euo pipefail

# Source common library
LIB_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../lib" && pwd)"
source "${LIB_DIR}/common.sh"

FORCE=${FORCE:-0}
CLOUD_DIR="{{ .chezmoi.homeDir }}/Library/CloudStorage"
HOME_DIR="{{ .chezmoi.homeDir }}"

if [ ! -d "$CLOUD_DIR" ]; then
    log_info "CloudStorage directory not found at: $CLOUD_DIR"
    log_info "This is normal if cloud services (iCloud, Dropbox, etc.) are not configured"
    log_info "Skipping cloud symlink setup"
    exit 0
fi

require_flag "FORCE" "cloud storage symlink creation"

log_info "‚òÅÔ∏è  Checking CloudStorage directories..."

cleanup() {
    :
}
trap cleanup EXIT

# Iterate through directories in CloudStorage
for target in "$CLOUD_DIR"/*; do
    if [ -d "$target" ]; then
        default_name=$(basename "$target")

        if [ -c /dev/tty ]; then
            echo "---------------------------------------------------"
            echo "Found: $default_name"
            echo -n "üîó Create symlink for '$default_name'? [y/N]: "
            read answer < /dev/tty

            case "$answer" in
                [yY]*)
                    echo -n "üìù Enter link name [default: $default_name]: "
                    read input_name < /dev/tty

                    link_name="${input_name:-$default_name}"
                    link_path="$HOME_DIR/$link_name"

                    if [ -e "$link_path" ] && [ ! -L "$link_path" ]; then
                        log_error "Cannot create symlink: $link_path already exists and is not a symlink"
                        log_info "To fix: Move or remove the existing file/directory first"
                        log_info "  mv \"$link_path\" \"$link_path.backup\""
                        continue
                    fi

                    if ln -sFn "$target" "$link_path"; then
                        log_success "Created: $link_path -> $target"
                    else
                        log_error "Failed to create symlink: $link_path -> $target"
                        log_info "Check permissions: ls -la \"$(dirname "$link_path")\""
                    fi
                    ;;
                *)
                    echo "‚è≠Ô∏è  Skipped: $default_name"
                    ;;
            esac
        else
            log_warning "No TTY available, cannot prompt for '$default_name'"
            log_info "Run this script in an interactive terminal to create symlinks"
        fi
    fi
 done