#!/bin/bash
set -euo pipefail

# Source common library
LIB_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../lib" && pwd)"
source "${LIB_DIR}/common.sh"

FORCE=${FORCE:-0}
CLOUD_DIR="{{ .chezmoi.homeDir }}/Library/CloudStorage"
HOME_DIR="{{ .chezmoi.homeDir }}"

if [ ! -d "$CLOUD_DIR" ]; then
    log_warning "No CloudStorage directory. Skipping"
    exit 0
fi

require_flag "FORCE" "„ÇØ„É©„Ç¶„Éâ„Çπ„Éà„É¨„Éº„Ç∏„Ç∑„É≥„Éú„É™„ÉÉ„ÇØ„É™„É≥„ÇØ‰ΩúÊàê"

log_info "‚òÅÔ∏è  Checking CloudStorage directories..."

cleanup() {
    :
}
trap cleanup EXIT

# Iterate through directories in CloudStorage
for target in "$CLOUD_DIR"/*; do
    if [ -d "$target" ]; then
        default_name=$(basename "$target")

        if [ -c /dev/tty ]; then
            echo "---------------------------------------------------"
            echo "Found: $default_name"
            echo -n "üîó Create symlink for '$default_name'? [y/N]: "
            read answer < /dev/tty

            case "$answer" in
                [yY]*)
                    echo -n "üìù Enter link name [default: $default_name]: "
                    read input_name < /dev/tty

                    link_name="${input_name:-$default_name}"
                    link_path="$HOME_DIR/$link_name"

                    if [ -e "$link_path" ] && [ ! -L "$link_path" ]; then
                        echo "‚ùå $link_path exists and is not a symlink. Skipping to avoid overwrite." >&2
                        continue
                    fi

                    if ln -sFn "$target" "$link_path"; then
                        log_success "Created: $link_path -> $target"
                    else
                        log_error "Failed to create symlink: $link_path"
                    fi
                    ;;
                *)
                    echo "‚è≠Ô∏è  Skipped: $default_name"
                    ;;
            esac
        else
            echo "Warning: No TTY available. Skipping '$default_name'."
        fi
    fi
 done