#!/bin/bash
set -euo pipefail

# hash: {{ include "dot_config/stats/eu.exelban.Stats.plist" | sha256sum }}

SOURCE_ROOT="${CHEZMOI_SOURCE_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)}"

# Source shared bootstrap
# shellcheck source=../lib/bootstrap.sh
# shellcheck disable=SC1091
source "${SOURCE_ROOT}/.internal_scripts/lib/bootstrap.sh"

log_info "Detected changes in Stats (eu.exelban.Stats) configuration. Importing to system..."

PLIST_PATH="{{ .chezmoi.homeDir }}/.config/stats/eu.exelban.Stats.plist"

if [ ! -f "$PLIST_PATH" ]; then
	record_failure "Stats configuration file not found: $PLIST_PATH"
	log_info "Expected location: ~/.config/stats/eu.exelban.Stats.plist"
	log_info "This file should be created by chezmoi when applying the configuration"
	log_info "Try running: chezmoi apply ~/.config/stats/eu.exelban.Stats.plist"
	report_failures
	exit 1
fi

# Validate plist format
if ! plutil -lint "$PLIST_PATH" >/dev/null 2>&1; then
	record_failure "Stats plist file is corrupted or invalid: $PLIST_PATH"
	log_info "Check file format: plutil -lint \"$PLIST_PATH\""
	report_failures
	exit 1
fi

# Import settings from XML file
if ! defaults import eu.exelban.Stats "$PLIST_PATH"; then
	record_failure "Failed to import Stats plist"
	report_failures
	exit 1
fi

log_success "Stats plist imported successfully"

# Prompt reload to maintain cache consistency
if ! kill_process "cfprefsd"; then
	record_failure "Restart cfprefsd"
fi
if ! kill_process "Stats"; then
	record_failure "Restart Stats"
fi
open -a Stats || true

report_failures
