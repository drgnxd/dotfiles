#!/bin/bash
set -euo pipefail

# hash: {{ include "dot_config/stats/eu.exelban.Stats.plist" | sha256sum }}

# Source common library
if [ -n "${CHEZMOI_SOURCE_DIR:-}" ]; then
  LIB_DIR="${CHEZMOI_SOURCE_DIR}/.internal_scripts/lib"
else
  LIB_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../lib" && pwd)"
fi
source "${LIB_DIR}/common.sh"

log_info "Detected changes in Stats (eu.exelban.Stats) configuration. Importing to system..."

PLIST_PATH="{{ .chezmoi.homeDir }}/.config/stats/eu.exelban.Stats.plist"

if [ ! -f "$PLIST_PATH" ]; then
  log_error "Stats configuration file not found: $PLIST_PATH"
  log_info "Expected location: ~/.config/stats/eu.exelban.Stats.plist"
  log_info "This file should be created by chezmoi when applying the configuration"
  log_info "Try running: chezmoi apply ~/.config/stats/eu.exelban.Stats.plist"
  exit 1
fi

# Validate plist format
if ! plutil -lint "$PLIST_PATH" >/dev/null 2>&1; then
  log_error "Stats plist file is corrupted or invalid: $PLIST_PATH"
  log_info "Check file format: plutil -lint \"$PLIST_PATH\""
  exit 1
fi

# Import settings from XML file
if ! defaults import eu.exelban.Stats "$PLIST_PATH"; then
  log_error "Failed to import Stats plist"
  exit 1
fi

log_success "Stats plist imported successfully"

# Prompt reload to maintain cache consistency
kill_process "cfprefsd"
kill_process "Stats"
open -a Stats || true
