# zsh completion setup

# Prefer Homebrew zsh-completions if available
if [ -n "$HOMEBREW_PREFIX" ] && [ -d "$HOMEBREW_PREFIX/share/zsh-completions" ]; then
  fpath=("$HOMEBREW_PREFIX/share/zsh-completions" $fpath)
fi

# Initialize completion system (use cache for speed)
ZSH_COMPDUMP="${XDG_CACHE_HOME:-$HOME/.cache}/zsh/zcompdump"
if [ ! -d "${ZSH_COMPDUMP%/*}" ]; then
  mkdir -p "${ZSH_COMPDUMP%/*}"
fi
autoload -U compinit
compinit -C -d "$ZSH_COMPDUMP"

# Visual and matching styles
zstyle ':completion:*' menu select
zstyle ':completion:*' verbose yes
zstyle ':completion:*:descriptions' format '%F{green}-- %d --%f'
zstyle ':completion:*:messages' format '%F{yellow}%d%f'
zstyle ':completion:*:warnings' format '%F{red}No matches for: %d%f'
zstyle ':completion:*:group-name' format '%F{blue}%B%d%b%f'
zstyle ':completion:*' group-name ''
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Z}'

# Completion cache
zstyle ':completion:*' use-cache on
zstyle ':completion:*' cache-path "${XDG_CACHE_HOME:-$HOME/.cache}/zsh/zcompcache"

# Process and system related completions
zstyle ':completion:*:*:kill:*:processes' list-colors '=(#b) #([0-9]#) ([0-9a-z-]#)*=01;34=0=01'
zstyle ':completion:*:*:*:*:processes' command "ps -u $USER -o pid,user,comm -w -w"
zstyle ':completion:*:(ssh|scp|rsync):*' hosts 'reply=(${=${${(f)"$(cat {/etc/ssh_,~/.ssh/known_}hosts(|2)(N) /dev/null)"}%%[# ]*}//,/ })'

# Git and directory stack tweaks
zstyle ':completion:*:git-checkout:*' sort false
zstyle ':completion:*:git-*:*' verbose yes
zstyle ':completion:*:*:cd:*:directory-stack' menu yes select

# Verbose completion output and selection prompt
zstyle ':completion:*' extra-verbose yes
zstyle ':completion:*' menu select=long
zstyle ':completion:*' select-prompt %SScrolling active: current selection at %p%s

# Taskwarrior: use cached IDs/descriptions for completion
_task_ids_describe() {
    typeset -ga TASK_CACHE_DESC
    if (( ${#TASK_CACHE_DESC} )); then
        _describe -t task-ids 'task IDs' TASK_CACHE_DESC
    fi
}

zstyle ':completion:*:*:task:*' completer _oldlist _task_ids_describe _complete
zstyle ':completion:*:*:task:*' group-name ''
zstyle ':completion:*:*:task:*' tag-order 'task-ids' 'options' 'arguments'
