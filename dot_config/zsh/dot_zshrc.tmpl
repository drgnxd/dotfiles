# ~/.config/zsh/.zshrc
#
# Index file that loads individual configs
# Actual configuration lives in dot_* files

# Path to Zsh config files
ZDOTDIR="${XDG_CONFIG_HOME:-$HOME/.config}/zsh"

# Ordered list of config files (order matters)
local -a zsh_config_files
zsh_config_files=(
  "$ZDOTDIR/.exports"        # 1. Environment variables (PATH etc.)
  "$ZDOTDIR/.zsh_options"    # 2. Zsh options (history, prompt, etc.)
  "$ZDOTDIR/.aliases"        # 3. Aliases
  "$ZDOTDIR/.functions"      # 4. Functions
  "$ZDOTDIR/.homebrew"       # 5. Homebrew (resolve paths before plugins)
  "$ZDOTDIR/.zsh_completion" # 6. Completion
  "$ZDOTDIR/.completions"    # 7. Per-command completions
  "$ZDOTDIR/.zsh_plugins"    # 8. Plugins (may depend on Homebrew paths)
  "$ZDOTDIR/.pyenv"          # 9. pyenv
  "$ZDOTDIR/.zoxide"         # 10. zoxide
  "$ZDOTDIR/.proton"         # 11. Proton Pass
  "$ZDOTDIR/.lima"           # 12. Lima & Docker
  "$ZDOTDIR/.fzf_theme"      # 13. FZF Solarized Theme
  "$ZDOTDIR/.fzf"            # 14. fzf integration
  "$ZDOTDIR/.direnv"         # 15. direnv (load last)
)

# Source each file if it exists
for file in "${zsh_config_files[@]}"; do
  [ -f "$file" ] && . "$file"
done

# Initialize Taskwarrior cache
_task_cache_load

unset zsh_config_files file

# --- Local Settings ---
# Load only if present (git-ignored)
if [ -f "$HOME/.config/zsh/local.zsh" ]; then
    source "$HOME/.config/zsh/local.zsh"
fi

# --- Compile .zshrc for faster startup (best-effort) ---
if [[ -f "$ZDOTDIR/.zshrc" ]]; then
  if [[ ! -f "$ZDOTDIR/.zshrc.zwc" || "$ZDOTDIR/.zshrc" -nt "$ZDOTDIR/.zshrc.zwc" ]]; then
    {
      if ! zcompile "$ZDOTDIR/.zshrc" 2>/dev/null; then
        print -u2 "Warning: failed to compile $ZDOTDIR/.zshrc"
      fi
    } &!
  fi
fi
