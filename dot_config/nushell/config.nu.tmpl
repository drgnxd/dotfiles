# Nushell Configuration
# Auto-generated loader with Chezmoi templates
# Note: show_banner is set in env.nu (loaded before this file)

# =============================================================================
# CORE CONFIGURATION
# =============================================================================

# History (SQLite-based)
$env.config.history = {
    file_format: "sqlite"
    max_size: 1_000_000
    sync_on_enter: true
    isolation: false
}

# Filesize display (disabled - config options changed in Nushell 0.110)
# $env.config.filesize_metric = false
# $env.config.filesize_format = "auto"

# Completions
$env.config.completions = {
    case_sensitive: false
    quick: true
    partial: true
    algorithm: "prefix"
    external: {
        enable: true
        max_results: 100
        completer: {|spans|
            if (which carapace | is-not-empty) {
                carapace $spans.0 nushell ...$spans | from json
            } else {
                null
            }
        }
    }
}

# UI Settings
# Note: show_banner is set in env.nu
$env.config.error_style = "fancy"
$env.config.edit_mode = "emacs"
$env.config.use_kitty_protocol = true
$env.config.bracketed_paste = true
$env.config.highlight_resolved_externals = true
$env.config.float_precision = 2

# Cursor shapes
$env.config.cursor_shape = {
    emacs: block
    vi_insert: block
    vi_normal: block
}

# Bell (disabled - config structure changed in Nushell 0.110)
# $env.config.bell = {
#     sound: default
#     duration: 10ms
# }

# Table display
$env.config.table = {
    mode: "rounded"
    index_mode: "always"
    trim: {
        methodology: "wrapping"
        wrapping_try_keep_words: true
        truncating_suffix: "..."
    }
}

# Datetime formats
$env.config.datetime_format = {
    normal: "%a, %d %b %Y %H:%M:%S %z"
    table: "%Y-%m-%d %H:%M:%S"
}

# Shell integration (OSC codes)
$env.config.shell_integration = {
    osc8: true
    osc9_9: false
    osc133: true
    osc633: true
}

# Display settings
$env.config.render_right_prompt_on_last_line = false
# $env.config.display_errors.line_by_line = true  # disabled - option changed in Nushell 0.110

# Keybindings
$env.config.keybindings = [
    {
        name: completion_menu
        modifier: none
        keycode: tab
        mode: [emacs vi_normal vi_insert]
        event: {
            until: [
                { send: menu name: completion_menu }
                { send: menunext }
                { edit: complete }
            ]
        }
    }
    {
        name: history_menu
        modifier: control
        keycode: char_r
        mode: [emacs vi_insert vi_normal]
        event: { send: menu name: history_menu }
    }
]

# Menus
$env.config.menus = [
    {
        name: completion_menu
        only_buffer_difference: false
        marker: "| "
        type: {
            layout: columnar
            columns: 4
            col_width: 20
            col_padding: 2
        }
        style: {
            text: green
            selected_text: green_reverse
            description_text: yellow
        }
    }
    {
        name: history_menu
        only_buffer_difference: true
        marker: "? "
        type: {
            layout: list
            page_size: 10
        }
        style: {
            text: green
            selected_text: green_reverse
            description_text: yellow
        }
    }
]

# =============================================================================
# AUTOLOAD MODULES (Generated by Chezmoi)
# =============================================================================

{{- $autoloadDir := "/Users/drgnxd/.config/nushell/autoload" }}
{{- range $file := glob (joinPath .chezmoi.sourceDir "dot_config/nushell/autoload" "*.nu") }}
{{- $basename := base $file }}
{{- if not (hasPrefix "README" $basename) }}
{{- $fullPath := joinPath $autoloadDir $basename }}
source {{ $fullPath }}
{{- end }}
{{- end }}

# Templated autoloads rendered by chezmoi (e.g., 07-source-tools.nu)
{{- $sourceTools := joinPath $autoloadDir "07-source-tools.nu" }}
let source_tools = "{{ $sourceTools }}"
if ($source_tools | path exists) {
    source {{ $sourceTools }}
}

# =============================================================================
# LOCAL CONFIGURATION (User-specific overrides)
# =============================================================================

# User-local settings can be added to ~/.config/nushell/local.nu
{{- $localNu := joinPath .chezmoi.homeDir ".config/nushell/local.nu" }}
{{- if stat $localNu }}
# Local configuration found - sourcing
source ~/.config/nushell/local.nu
{{- else }}
# Local configuration not found (~/.config/nushell/local.nu)
# Create this file for machine-specific settings
{{- end }}
