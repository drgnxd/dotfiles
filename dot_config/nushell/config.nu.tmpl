# Nushell Configuration
# Auto-generated loader with Chezmoi templates
# Note: show_banner is set in env.nu (loaded before this file)

# =============================================================================
# CORE CONFIGURATION
# =============================================================================

# History (SQLite-based)
$env.config.history = {
    file_format: "sqlite"
    max_size: 1_000_000
    sync_on_enter: true
    isolation: false
}

# Filesize display (disabled - config options changed in Nushell 0.110)
# $env.config.filesize_metric = false
# $env.config.filesize_format = "auto"

# Completions
$env.config.completions = {
    case_sensitive: false
    quick: true
    partial: true
    algorithm: "prefix"
    external: {
        enable: true
        max_results: 100
        completer: {|spans|
            if (which carapace | is-not-empty) {
                carapace $spans.0 nushell ...$spans | from json
            } else {
                null
            }
        }
    }
}

# UI Settings
# Note: show_banner is set in env.nu
$env.config.error_style = "fancy"
$env.config.edit_mode = "emacs"
$env.config.use_kitty_protocol = true
$env.config.bracketed_paste = true
$env.config.highlight_resolved_externals = true
$env.config.float_precision = 2

# Cursor shapes
$env.config.cursor_shape = {
    emacs: block
    vi_insert: block
    vi_normal: block
}

# Bell (disabled - config structure changed in Nushell 0.110)
# $env.config.bell = {
#     sound: default
#     duration: 10ms
# }

# Table display
$env.config.table = {
    mode: "rounded"
    index_mode: "always"
    trim: {
        methodology: "wrapping"
        wrapping_try_keep_words: true
        truncating_suffix: "..."
    }
}

# Datetime formats
$env.config.datetime_format = {
    normal: "%a, %d %b %Y %H:%M:%S %z"
    table: "%Y-%m-%d %H:%M:%S"
}

# Shell integration (OSC codes)
$env.config.shell_integration = {
    osc8: true
    osc9_9: false
    osc133: true
    osc633: true
}

# Display settings
$env.config.render_right_prompt_on_last_line = false
# $env.config.display_errors.line_by_line = true  # disabled - option changed in Nushell 0.110

# Keybindings
let task_preview_repaint_keys = [
    {
        name: task_preview_digit_0
        modifier: none
        keycode: char_0
        mode: [emacs vi_insert]
        event: [
            { edit: insertchar value: "0" }
            { send: executehostcommand cmd: "task_preview_update" }
            { send: repaint }
        ]
    }
    {
        name: task_preview_digit_1
        modifier: none
        keycode: char_1
        mode: [emacs vi_insert]
        event: [
            { edit: insertchar value: "1" }
            { send: executehostcommand cmd: "task_preview_update" }
            { send: repaint }
        ]
    }
    {
        name: task_preview_digit_2
        modifier: none
        keycode: char_2
        mode: [emacs vi_insert]
        event: [
            { edit: insertchar value: "2" }
            { send: executehostcommand cmd: "task_preview_update" }
            { send: repaint }
        ]
    }
    {
        name: task_preview_digit_3
        modifier: none
        keycode: char_3
        mode: [emacs vi_insert]
        event: [
            { edit: insertchar value: "3" }
            { send: executehostcommand cmd: "task_preview_update" }
            { send: repaint }
        ]
    }
    {
        name: task_preview_digit_4
        modifier: none
        keycode: char_4
        mode: [emacs vi_insert]
        event: [
            { edit: insertchar value: "4" }
            { send: executehostcommand cmd: "task_preview_update" }
            { send: repaint }
        ]
    }
    {
        name: task_preview_digit_5
        modifier: none
        keycode: char_5
        mode: [emacs vi_insert]
        event: [
            { edit: insertchar value: "5" }
            { send: executehostcommand cmd: "task_preview_update" }
            { send: repaint }
        ]
    }
    {
        name: task_preview_digit_6
        modifier: none
        keycode: char_6
        mode: [emacs vi_insert]
        event: [
            { edit: insertchar value: "6" }
            { send: executehostcommand cmd: "task_preview_update" }
            { send: repaint }
        ]
    }
    {
        name: task_preview_digit_7
        modifier: none
        keycode: char_7
        mode: [emacs vi_insert]
        event: [
            { edit: insertchar value: "7" }
            { send: executehostcommand cmd: "task_preview_update" }
            { send: repaint }
        ]
    }
    {
        name: task_preview_digit_8
        modifier: none
        keycode: char_8
        mode: [emacs vi_insert]
        event: [
            { edit: insertchar value: "8" }
            { send: executehostcommand cmd: "task_preview_update" }
            { send: repaint }
        ]
    }
    {
        name: task_preview_digit_9
        modifier: none
        keycode: char_9
        mode: [emacs vi_insert]
        event: [
            { edit: insertchar value: "9" }
            { send: executehostcommand cmd: "task_preview_update" }
            { send: repaint }
        ]
    }
    {
        name: task_preview_backspace
        modifier: none
        keycode: backspace
        mode: [emacs vi_insert]
        event: [
            { edit: backspace }
            { send: executehostcommand cmd: "task_preview_update" }
            { send: repaint }
        ]
    }
    {
        name: task_preview_delete
        modifier: none
        keycode: delete
        mode: [emacs vi_insert]
        event: [
            { edit: delete }
            { send: executehostcommand cmd: "task_preview_update" }
            { send: repaint }
        ]
    }
    {
        name: task_preview_cancel
        modifier: control
        keycode: char_c
        mode: [emacs vi_insert vi_normal]
        event: [
            { send: executehostcommand cmd: "task_preview_clear" }
            { send: ctrlc }
        ]
    }
]

$env.config.keybindings = (
    ($env.config.keybindings | default [])
    | append $task_preview_repaint_keys
)

# Menus
$env.config.menus = [
    {
        name: completion_menu
        only_buffer_difference: false
        marker: "| "
        type: {
            layout: columnar
            columns: 4
            col_width: 20
            col_padding: 2
        }
        style: {
            text: green
            selected_text: green_reverse
            description_text: yellow
        }
    }
    {
        name: history_menu
        only_buffer_difference: true
        marker: "? "
        type: {
            layout: list
            page_size: 10
        }
        style: {
            text: green
            selected_text: green_reverse
            description_text: yellow
        }
    }
]

# =============================================================================
# AUTOLOAD MODULES (Generated by Chezmoi)
# =============================================================================

{{- $autoloadDir := "/Users/drgnxd/.config/nushell/autoload" }}
{{- range $file := glob (joinPath .chezmoi.sourceDir "dot_config/nushell/autoload" "*.nu") }}
{{- $basename := base $file }}
{{- if not (hasPrefix "README" $basename) }}
{{- $fullPath := joinPath $autoloadDir $basename }}
source {{ $fullPath }}
{{- end }}
{{- end }}

# Templated autoloads rendered by chezmoi (e.g., 07-source-tools.nu)
{{- $sourceTools := joinPath $autoloadDir "07-source-tools.nu" }}
let source_tools = "{{ $sourceTools }}"
if ($source_tools | path exists) {
    source {{ $sourceTools }}
}

# =============================================================================
# LOCAL CONFIGURATION (User-specific overrides)
# =============================================================================

# User-local settings can be added to ~/.config/nushell/local.nu
{{- $localNu := joinPath .chezmoi.homeDir ".config/nushell/local.nu" }}
{{- if stat $localNu }}
# Local configuration found - sourcing
source ~/.config/nushell/local.nu
{{- else }}
# Local configuration not found (~/.config/nushell/local.nu)
# Create this file for machine-specific settings
{{- end }}
