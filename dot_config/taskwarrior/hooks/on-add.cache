#!/usr/bin/env python3
import sys
import json
import os

def update_cache():
    cache_dir = os.path.expanduser("~/.cache/taskwarrior")
    os.makedirs(cache_dir, exist_ok=True)
    
    # Run task command to get pending IDs and descriptions
    import subprocess
    try:
        # Get pending tasks in JSON format
        output = subprocess.check_output(["task", "status:pending", "export"], stderr=subprocess.DEVNULL)
        tasks = json.loads(output)
        
        ids = []
        descs = []
        for t in tasks:
            if "id" in t and t["id"] != 0:
                ids.append(str(t["id"]))
                descs.append(f"{t['id']}: {t['description']}")
        
        with open(os.path.join(cache_dir, "ids.list"), "w") as f:
            f.write("\n".join(ids))
        with open(os.path.join(cache_dir, "desc.list"), "w") as f:
            f.write("\n".join(descs))
    except Exception:
        pass

if __name__ == "__main__":
    # Taskwarrior on-modify hooks receive two JSON objects: original and modified.
    # We must output the modified task JSON.
    # Maybe I should use json.loads to ensure I'm getting valid objects.
    
    raw_input = sys.stdin.read().strip()
    # Taskwarrior on-modify input is <old>\n<new>
    # split by \n and parse
    lines = [l for l in raw_input.split('\n') if l.strip()]
    
    if len(lines) >= 2:
        # The modified task is the last one
        modified_task = json.loads(lines[-1])
        print(json.dumps(modified_task))
    elif len(lines) == 1:
        modified_task = json.loads(lines[0])
        print(json.dumps(modified_task))
        
    sys.stdout.flush()
    os._exit(0)

