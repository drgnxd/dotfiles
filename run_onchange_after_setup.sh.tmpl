{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash

# .internal_scripts/darwin/install_packages.sh.tmpl hash: {{ include ".internal_scripts/darwin/install_packages.sh.tmpl" | sha256sum }}
# .internal_scripts/darwin/setup_cloud_symlinks.sh.tmpl hash: {{ include ".internal_scripts/darwin/setup_cloud_symlinks.sh.tmpl" | sha256sum }}
# .internal_scripts/darwin/import_stats.sh.tmpl hash: {{ include ".internal_scripts/darwin/import_stats.sh.tmpl" | sha256sum }}

set -euo pipefail

# Define script directory relative to the source directory
SCRIPT_DIR="{{ .chezmoi.sourceDir }}/.internal_scripts/darwin"
LIB_DIR="{{ .chezmoi.sourceDir }}/.internal_scripts/lib"
source "${LIB_DIR}/common.sh"
export CHEZMOI_SOURCE_DIR="{{ .chezmoi.sourceDir }}"

CONTINUE_ON_ERROR=${CONTINUE_ON_ERROR:-0}

run_step() {
  local step_name=$1
  shift

  log_info "Running ${step_name}..."
  if "$@"; then
    log_success "${step_name} completed"
    return 0
  fi

  log_error "${step_name} failed"
  if [ "${CONTINUE_ON_ERROR:-0}" != "1" ]; then
    exit 1
  fi
  
  log_warning "Continuing despite failure (CONTINUE_ON_ERROR=1)"
}

log_info "Starting macOS setup..."

# 1. Install Packages (Homebrew)
log_info "Preparing package installation..."
# We need to execute the template content directly or render it to a temporary file
# primarily because it contains template logic itself.
run_step "Install Packages" bash <(cat << 'EOF'
{{ include ".internal_scripts/darwin/install_packages.sh.tmpl" }}
EOF
)

# 2. System Defaults
run_step "System Defaults" bash "${SCRIPT_DIR}/system_defaults.sh"

# 3. Security Hardening
run_step "Security Hardening" bash "${SCRIPT_DIR}/security_hardening.sh"

# 4. Audit Security
run_step "Audit Security" bash "${SCRIPT_DIR}/audit_security.sh"

# 5. Keyboard Setup
run_step "Keyboard Setup" bash "${SCRIPT_DIR}/keyboard.sh"

# 6. Menubar Setup
run_step "Menubar Setup" bash "${SCRIPT_DIR}/menubar.sh"

# 7. Login Items
run_step "Login Items" bash "${SCRIPT_DIR}/login_items.sh"

# 8. Setup Cloud Symlinks
run_step "Setup Cloud Symlinks" bash <(cat << 'EOF'
{{ include ".internal_scripts/darwin/setup_cloud_symlinks.sh.tmpl" }}
EOF
)

# 9. Import Stats
run_step "Import Stats" bash <(cat << 'EOF'
{{ include ".internal_scripts/darwin/import_stats.sh.tmpl" }}
EOF
)

log_success "macOS setup completed successfully."
{{- end -}}
