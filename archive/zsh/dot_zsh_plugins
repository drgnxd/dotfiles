# Load plugins installed via Homebrew

# Assumes HOMEBREW_PREFIX is set in the preceding .homebrew file
if [ -n "$HOMEBREW_PREFIX" ]; then
  # fast-syntax-highlighting (load first)
  if [ -f "$HOMEBREW_PREFIX/share/zsh-fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh" ]; then
      source "$HOMEBREW_PREFIX/share/zsh-fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh"
      
      # Load custom Chroma definitions
      # Define configuration directory
      local fsh_config_dir="${ZDOTDIR:-$HOME/.config/zsh}/fsh"
      
      # Load Chroma definition files
      if [ -d "$fsh_config_dir" ]; then
          for chroma_file in "$fsh_config_dir"/chroma-*.ch(N); do
              local cmd_name="${chroma_file:t:r:s/chroma-//}"
              if [ -f "$chroma_file" ]; then
                  source "$chroma_file"
                  FAST_HIGHLIGHT[chroma-${cmd_name}]="chroma/${cmd_name}"
              fi
          done
      fi

      if typeset -A FAST_HIGHLIGHT >/dev/null 2>&1; then
          register_chroma_alias() {
              local alias_name="$1"
              local target_command="$2"
              local target_key="chroma-${target_command}"
              local target_value="${FAST_HIGHLIGHT[$target_key]}"

              [[ -n "$alias_name" && -n "$target_value" ]] || return 0
              FAST_HIGHLIGHT["chroma-${alias_name}"]="$target_value"
          }

          local -a chroma_aliases
          chroma_aliases=(
              "ls:eza"
              "ll:eza"
              "la:eza"
              "lt:eza"
              "g:rg"
              "lg:lazygit"
              "f:fd"
              "cat:bat"
              "t:task"
              "c:chezmoi"
              "ca:chezmoi"
              "ce:chezmoi"
          )

           local entry
           for entry in "${chroma_aliases[@]}"; do
               register_chroma_alias "${entry%%:*}" "${entry#*:}"
           done
      fi
  fi
  # zsh-autosuggestions (load after fsh)
  if [ -f "$HOMEBREW_PREFIX/share/zsh-autosuggestions/zsh-autosuggestions.zsh" ]; then
      source "$HOMEBREW_PREFIX/share/zsh-autosuggestions/zsh-autosuggestions.zsh"
  fi

  # fast-syntax-highlighting is used with Chroma definitions

fi

# Start Starship (Prompt)
if command -v starship >/dev/null 2>&1; then
    eval "$(starship init zsh)"
fi

# Task preview widget (must be after all plugins are loaded)
if (( $+functions[_task_preview_widget] )); then
    zle -N _task_preview_widget
    # Use zle-line-pre-redraw to update preview on every keystroke
    function _task_zle_line_pre_redraw() {
        _task_preview_widget
    }
    zle -N zle-line-pre-redraw _task_zle_line_pre_redraw
fi
