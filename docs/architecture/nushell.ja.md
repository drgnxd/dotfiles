# Nushell設定

Nushellは、全てをデータとして扱うモダンなシェルです。この設定は、XDG準拠と条件付きコマンド読み込みを備えた、モジュール化され保守性の高い構成を提供します。

## アーキテクチャ

`autoload/`ディレクトリパターンを使用したモジュール構造を採用しています：

```
dot_config/nushell/
├── env.nu.tmpl              # テンプレート -> ~/.config/nushell/env.nu
├── config.nu.tmpl           # テンプレート -> ~/.config/nushell/config.nu
└── autoload/
    ├── 00-helpers.nu       # 共通ヘルパー
    ├── 01-env.nu           # 環境変数とXDGパス
    ├── 02-path.nu          # std/utilを使用したPATH設定
    ├── 03-aliases.nu       # フォールバック付きエイリアス
    ├── 04-functions.nu     # カスタム関数とラッパー
    ├── 05-completions.nu   # コマンド補完
    ├── 06-integrations.nu  # サードパーティツール統合
    ├── 07-source-tools.nu.tmpl # テンプレート -> autoload/07-source-tools.nu
    ├── 08-taskwarrior.nu   # Taskwarriorプレビュー統合
    └── 09-lima.nu          # Lima/Dockerヘルパー
```

## モジュール読み込み

生成された`config.nu`（`config.nu.tmpl`からレンダリング）はChezmoiテンプレートを使用して`.nu`モジュールとキャッシュ読み込み用の`source`コマンドを自動生成します：

```nushell
# AUTOLOAD MODULES (Generated by Chezmoi)
source ($nu.default-config-dir | path join "autoload" "01-env.nu")
source ($nu.default-config-dir | path join "autoload" "02-path.nu")
...
```

このアプローチにより、動的な`ls | each { source }`パターンで発生するパース時評価の問題を回避します。

## 主な機能

### 1. XDG Base Directory準拠

全てのアプリケーションデータはXDG準拠の場所に保存されます：
- 設定: `~/.config/`
- キャッシュ: `~/.cache/`
- データ: `~/.local/share/`
- 状態: `~/.local/state/`

完全なXDGパス設定は`01-env.nu`を参照してください。

### 2. 条件付きコマンド読み込み

コマンドは、標準ツールへの自動フォールバック付きで定義されます：

```nushell
export def g [...args] {
    if (has-cmd rg) {
        rg ...$args
    } else {
        ^grep ...$args
    }
}
```

これにより、モダンなツール（bat、fd、ripgrep）がインストールされていない異なるシステムでも設定が機能します。

### 3. 標準ライブラリ統合

Nushellの`std/util`を使用してPATHを管理します：

```nushell
use std "path add"
path add ($env.HOME | path join ".local" "bin")
```

### 4. ENV_CONVERSIONS

コロン区切りの環境変数（PATH、TERMINFO_DIRS等）は、適切なコンバータで処理されます：

```nushell
$env.ENV_CONVERSIONS = ($env.ENV_CONVERSIONS | default {}) | merge {
    "PATH": {
        from_string: {|s| $s | split row (char esep) | path expand --no-symlink }
        to_string: {|v| $v | path expand --no-symlink | str join (char esep) }
    }
}
```

## 利用可能なエイリアスとコマンド

### ファイル操作
- `la`, `ld`, `lf`, `lsize` - リスト表示の派生（全/ディレクトリ/ファイル/サイズ順）
- `cat` - ファイル表示（使用可能な場合はbatを使用）
- `f` - ファイル検索（使用可能な場合はfdを使用）

### 検索
- `g` - ripgrepで検索（フォールバックはgrep）

### アプリケーションショートカット
- `ca`, `ce` - Chezmoi apply/edit
- `t` - Taskwarrior
- `lg` - LazyGit
- `oc`, `ocd` - opencode
- `pload` - Proton Pass CLI

### Lima/Docker
- `lls` - Lima VM一覧
- `dctx` - Dockerコンテキスト切り替え
- `dctx-reset` - デフォルトにリセット

### 関数
- `y` - cwd追跡付きYaziファイルマネージャ
- `zk` - git同期付きZettelkastenノート
- `ppget` - Proton Passパスワード取得
- `upgrade-all` / `update` - 統合システムアップグレード
- `save-stats` - Stats.app設定のエクスポート
- `bundle-id` - macOSアプリのバンドルID取得

## サードパーティ統合

### 自動初期化されるツール
- **Starship** - クロスシェルプロンプト
- **Zoxide** - スマートディレクトリジャンプ
- **Direnv** - 環境管理
- **Carapace** - コマンド補完
- **Atuin** - シェル履歴同期

全ての統合は、初期化前にコマンドの存在を確認します。生成された初期化スクリプトは`~/.cache/nushell-init`にキャッシュされ、`autoload/07-source-tools.nu`（テンプレートから生成）で読み込みます。

## 設定値

### 履歴
- 形式: SQLite
- 最大サイズ: 1,000,000エントリ
- 入力時同期: 有効
- 分離: 無効

### UI
- バナー: 無効
- エラースタイル: Fancy
- 編集モード: Emacs
- Kittyプロトコル: 有効
- ブラケット貼り付け: 有効

### 補完
- 大文字小文字区別: なし
- アルゴリズム: Prefix
- 外部補完: Carapace（使用可能な場合）

## Zshからの移行

この設定は以前のZshセットアップを置き換えます。主な変更点：

1. **.zshenv/.zshrcなし** - Nushellは`env.nu`と`config.nu`を使用
2. **.aliasesなし** - エイリアスは`03-aliases.nu`の`export def`コマンド
3. **.functionsなし** - 関数は`04-functions.nu`の`export def`
4. **モジュールシステム** - シェルのソースではなくNushellのモジュールシステムを使用

## ローカル上書き

マシン固有の設定には`~/.config/nushell/local.nu`を作成してください：

```nushell
# ~/.config/nushell/local.nu
$env.MY_LOCAL_VAR = "value"
alias mylocal = echo "local alias"
```

このファイルは`config.nu`の最後で自動的に読み込まれます。

## 参考

- [Nushell Book](https://www.nushell.sh/book/)
- [Nushell Cookbook](https://www.nushell.sh/cookbook/)
- [Chezmoi Templates](https://www.chezmoi.io/user-guide/templating/)
